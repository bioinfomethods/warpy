// Full path to the location of your warpy installation
BASE='/hpc/bpipeLibrary/shared/warpy-test'

REF_BASE='/hpc/genomeref/hg38/v0'
ARCHIE_HOME="/hpc/bpipeLibrary/shared/archie-test"

executor="torque"
queue="batch"
mem_param="mem"
memory="8"
proc_mode=1

libs=[
    "classes",
    "$BASE/lib/groovy-ngs-utils.jar",
    "$ARCHIE_HOME/archie-common/build/libs/archie-common-all.jar"
]

//Assume Miniconda and Homebrew are installed under /opt
parameters {
    setProperty('BASE',BASE)
    REF="$REF_BASE/Homo_sapiens_assembly38.fasta"

    tools {
        // Full path to samtools
        SAMTOOLS="samtools"
        
        // Full path to dorado
        DORADO="dorado"
        
        // Full path to minimap2
        MINIMAP2="minimap2"

        // Full path to pod5 Python package
        POD5="pod5"

        // Full path to bamstats 
        BAMSTATS="bamstats"

        // Fill path to Clair3
        CLAIR3="/opt/bin"

        PYPY="pypy"

        PARALLEL="parallel"
        
        WHATSHAP="whatshap"
        
        LONGPHASE="longphase"
    }

    model {
        params {
            basecaller_basemod_threads = 0
            remora_cfg = null
            remora_model_path = null
            // drd_model = 'dna_r10.4.1_e8.2_400bps_sup@v4.0.0'
            // drd_model = 'dna_r10.4.1_e8.2_400bps_hac@v4.0.0'
            // drd_model = 'dna_r10.4.1_e8.2_400bps_hac@v4.1.0'
            drd_model = 'dna_r10.4.1_e8.2_400bps_hac@v4.2.0'
            // drd_model = 'dna_r10.4.1_e8.2_400bps_hac@v4.3.0'
        }
    }
    
    calling {
        snp_min_af = 0.08
        indel_min_af = 0.15
        qscore_filter = 10
        ref_pct_full = 0.1
        var_pct_full = 0.7
        phasing_pct = 0.7
        
        // Full alignment
        min_mq = 5
        min_cov = 2
        
        // SV calling
        tr_bed = "$BASE/data/human_GRCh38_no_alt_analysis_set.trf.bed"
        cluster_merge_pos = 150
        min_sv_length = 30
        max_sv_length = 100000
        min_read_support = "auto"
        min_read_support_limit = 2
        sv_types = "DEL,INS"

        // STR calling
        repeats_bed = "$BASE/data/wf_str_repeats.bed"
        variant_catalogue_hg38 = "$BASE/data/variant_catalog_hg38.json"
     }
}

filesystems {
    reference_data {
        type='bind'
        base="$REF_BASE" // Full path to the location your reference data is in (this is used to mount it into containers)
    }
    
    scripts_bin {
        type='bind'
        base="$BASE/scripts"
    }
    
    data {
        type='bind'
        base="$BASE/data"
    }

    designs {
        type='bind'
        base="$BASE/designs"
    }

    models {
        type='bind'
        base="$BASE/models"
    }

}

limits {
    // How many copies of dorado can run at once: set to the number of GPUs 
    // that are accessible to the pipeline / how many you would like to use in parallel
    dorados = 1
}

containers {
    common_tools {
        type='singularity'
        image="$BASE/tools/ontresearch_dorado_4fdf39cb5afe.sif"
        storage=['reference_data', 'designs', 'models', 'ont_samples']
    }

    dorado_gpu {
        type='singularity'
        image="$BASE/tools/ontresearch_dorado_4fdf39cb5afe.sif"
        storage=['models', 'ont_samples']
        execOptions='--nv'
    }

    clair3 {
        type='singularity'
        image="$BASE/tools/clair3_v1.0.5.sif"
        storage=['reference_data', 'models']
    }

    mosdepth {
        type='singularity'
        image="$BASE/tools/ontresearch_wf-human-variation_558fdf2855c5.sif"
        storage=['reference_data', 'designs']
    }

    sniffles {
        type='singularity'
        image="$BASE/tools/ontresearch_wf-human-variation-sv_7104a232cd4b.sif"
        storage=['reference_data', 'data']
    }

    sniffles_filter {
        type='singularity'
        image="$BASE/tools/ontresearch_wf-human-variation-sv_7104a232cd4b.sif"
        storage=['scripts_bin', 'designs']
    }
}

stages {
    convert_fast5_to_pod5 {
        modules="singularity/3.8.4"
        walltime="1:00:00"
        procs=4
        memory="16g"
        container='common_tools'
    }

    dorado {
        modules="singularity/3.8.4"
        walltime="12:00:00"
        procs=4
        memory="256g"
        gpus=4
        queue='gpu'
        container='dorado_gpu'
    }

    make_mmi {
        modules="singularity/3.8.4"
        walltime="1:00:00"
        procs=4
        memory="16g"
        container='common_tools'
    }

    minimap2_align { 
        modules="singularity/3.8.4"
        walltime="8:00:00"
        procs=8
        memory="64g"
        container='common_tools' }

    merge_pass_calls {
        modules="singularity/3.8.4"
        walltime="2:00:00"
        procs=4
        memory="16g"
        container='common_tools'
    }

    mosdepth {
        modules="singularity/3.8.4"
        walltime="2:00:00"
        procs=4
        memory="16g"
        container='mosdepth'
    }

    read_stats {
        modules="singularity/3.8.4"
        walltime="2:00:00"
        procs=4
        memory="8g"
        container='sniffles'
    }

    make_clair3_chunks {
        modules="singularity/3.8.4"
        walltime="2:00:00"
        procs=4
        memory="8g"
        container='clair3'
    }

    pileup_variants {
        modules="singularity/3.8.4"
        walltime="4:00:00"
        procs=1
        memory="8g"
        container='clair3'
    }

    aggregate_pileup_variants {
        modules="singularity/3.8.4"
        walltime="2:00:00"
        procs=1
        memory="8g"
        container='clair3'
    }

    select_het_snps {
        modules="singularity/3.8.4"
        walltime="2:00:00"
        procs=1
        memory="16g"
        container='clair3'
    }

    phase_contig {
        modules="singularity/3.8.4"
        walltime="4:00:00"
        procs=4
        memory="16g"
        container='clair3'
    }

    get_qual_filter {
        modules="singularity/3.8.4"
        walltime="2:00:00"
        procs=1
        memory="8g"
        container='clair3'
    }

    create_candidates {
        modules="singularity/3.8.4"
        walltime="2:00:00"
        procs=1
        memory="8g"
        container='clair3'
    }

    evaluate_candidates {
        modules="singularity/3.8.4"
        walltime="2:00:00"
        procs=1
        memory="8g"
        container='clair3'
    }

    aggregate_full_align_variants {
        modules="singularity/3.8.4"
        walltime="4:00:00"
        procs=1
        memory="8g"
        container='clair3'
    }

    merge_pileup_and_full_vars {
        modules="singularity/3.8.4"
        walltime="4:00:00"
        procs=1
        memory="8g"
        container='clair3'
    }

    aggregate_all_variants {
        modules="singularity/3.8.4"
        walltime="4:00:00"
        procs=1
        memory="8g"
        container='clair3'
    }

    filterBam {
        modules="singularity/3.8.4"
        queue='batch'
        walltime="1:00:00"
        procs=4
        memory="16g"
        container='common_tools'
    }
    
    sniffles2 {
        modules="singularity/3.8.4"
        queue='batch'
        walltime="4:00:00"
        procs=8
        memory="64g"
        container='sniffles'
    }

    sort_sv_vcf {
        modules="singularity/3.8.4"
        queue='batch'
        walltime="4:00:00"
        procs=1
        memory="8g"
        container='sniffles'
    }

    filter_sv_calls {
        modules="singularity/3.8.4"
        queue='batch'
        walltime="4:00:00"
        procs=1
        memory="4g"
        container='sniffles_filter'
    }

    /*
    call_str { container = "str_container" }
    annotate_repeat_expansions  { container = "str_container" }
    merge_str_tsv  { container = "clair3" }
    merge_str_vcf  { container = "clair3" }
    */
    //read_stats { container = "clair3" }
    //make_str_report  { container = "str_container" }
}
